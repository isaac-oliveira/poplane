# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

fastlane_require 'dotenv'
default_platform(:ios)

require "./popcode.rb"

# Load correct environment file, the same one used for react-native-config

platform :ios do
  before_all do |lane, options|
    @changelog = changelog_from_git_commits(
      commits_count: 10,
      pretty: '- %s',
      tag_match_pattern: nil,
      match_lightweight_tag: false,
      include_merges: false
    )

    app_store_connect_api_key(
      key_id: "<key_id>", # Você precisa alterar esse campo
      issuer_id: "<issuer_id>", # Você precisa alterar esse campo
      key_filepath: "<key_filepath>", # Você precisa alterar esse campo
      duration: 500,
      in_house: false,
    )

    @export_options_appstore = {
      "provisioningProfiles": {
        "#{Popcode::AppIdentifier::Production}": "match AppStore #{Popcode::AppIdentifier::Production}",
      },
      "method": "app-store",
      "signingStyle": "manual",
    }

    @export_options_adhoc = {
      "provisioningProfiles": {
        "#{Popcode::AppIdentifier::Production}": "match AdHoc #{Popcode::AppIdentifier::Production}",
        "#{Popcode::AppIdentifier::Staging}": "match AdHoc #{Popcode::AppIdentifier::Staging}",
        "#{Popcode::AppIdentifier::Debug}": "match AdHoc #{Popcode::AppIdentifier::Debug}",
      },
      "method": "ad-hoc",
      "signingStyle": "manual",
    }

  end

  lane :certificates do
    register_devices(
      devices_file: "./fastlane/devices.txt", # Você precisa criar esse arquivo, caso ele não exista
    )

    match(app_identifier: Popcode::AppIdentifier::Production, type: "development", readonly: false, force_for_new_devices: true, team_id: Popcode::TeamId)
    match(app_identifier: Popcode::AppIdentifier::Production, type: "adhoc", readonly: false, force_for_new_devices: true, team_id: Popcode::TeamId)
    match(app_identifier: Popcode::AppIdentifier::Production, type: "appstore", readonly: false, force_for_new_devices: false, team_id: Popcode::TeamId)
    match(app_identifier: Popcode::AppIdentifier::Staging, type: "development", readonly: false, force_for_new_devices: true, team_id: Popcode::TeamId)
    match(app_identifier: Popcode::AppIdentifier::Staging, type: "adhoc", readonly: false, force_for_new_devices: true, team_id: Popcode::TeamId)
    match(app_identifier: Popcode::AppIdentifier::Staging, type: "appstore", readonly: false, force_for_new_devices: false, team_id: Popcode::TeamId)
    match(app_identifier: Popcode::AppIdentifier::Debug, type: "development", readonly: false, force_for_new_devices: true, team_id: Popcode::TeamId)
    match(app_identifier: Popcode::AppIdentifier::Debug, type: "adhoc", readonly: false, force_for_new_devices: true, team_id: Popcode::TeamId)
    match(app_identifier: Popcode::AppIdentifier::Debug, type: "appstore", readonly: false, force_for_new_devices: false, team_id: Popcode::TeamId)
  end

  desc "Envia uma build para testar o Fastlane"
  lane :test do
    clear_derived_data
    increment_build_number

    match(app_identifier: "#{Popcode::AppIdentifier::Debug}", type: "adhoc", force_for_new_devices: true)

    gym({
      export_method: "ad-hoc",
      export_options: @export_options_adhoc,
      scheme: Popcode::Scheme::Debug,
      silent: true,
      suppress_xcode_output: true,
      configuration: Popcode::Configuration::Debug
    })

    firebase_app_distribution(
      app: Popcode::Firebase::AppIdDebug,
      release_notes: @changelog,
      groups: "<groups>", # Você precisa alterar esse campo
    )
  end

  desc "Envia uma build de Desenvolvimento para o Firebase"
  lane :development do
    clear_derived_data
    increment_build_number

    match(app_identifier: "#{Popcode::AppIdentifier::Staging}", type: "adhoc", force_for_new_devices: true)

    gym({
      export_method: "ad-hoc",
      export_options: @export_options_adhoc,
      scheme: Popcode::Scheme::Staging,
      silent: true,
      suppress_xcode_output: true,
      configuration: Popcode::Configuration::Staging
    })

    sh(
      step_name: "Copiando binário para o ofuscador",
      command: "scp '../Mulvi Pay.ipa' <USER YOUR SERVER>@<YOUR SERVER ADRESS>:<PATH TO COPY IPA>/staging/app.ipa" # Você precisa alterar esse comando
    )
    sh(
      step_name: "Copiando arquivo de configuração do dexprotector para o ofuscador",
      command: "scp ../dexprotector-config-ipa.xml <USER YOUR SERVER>@<YOUR SERVER ADRESS>:<PATH TO COPY XML>/staging" # Você precisa alterar esse comando
    )
    sh(
      step_name: "Executando o script de ofuscamento",
      command: "ssh <USER YOUR SERVER>@<YOUR SERVER ADRESS> 'bash -s' < obfuscateBinary.sh staging ipa" # Você precisa alterar esse comando
    )
    sh(
      step_name: "Copiando binário ofuscado para a máquina local",
      command: "scp <USER YOUR SERVER>@<YOUR SERVER ADRESS>:<PATH TO COPY PROTECTED IPA>/staging/app.protected.ipa ../" # Você precisa alterar esse comando
    )

    get_provisioning_profile(
      adhoc: true,
      force: true,
      app_identifier: Popcode::AppIdentifier::Staging,
      filename: "#{Popcode::AppIdentifier::Staging}.mobileprovision"
    )

    resign(
      ipa: "app.protected.ipa",
      signing_identity: "<YOUR SIGNING CERTIFICATE> EX: iPhone Distribution: Luka Mirosevic (0123456789)", # Você precisa alterar esse campo
      provisioning_profile: "#{Popcode::AppIdentifier::Staging}.mobileprovision"
    )

    firebase_app_distribution(
      app: Popcode::Firebase::AppIdStaging,
      release_notes: @changelog,
      groups: "<groups>", # Você precisa alterar esse campo
      ipa_path: "app.protected.ipa"
    )
  end

  desc "Envia uma build de Homologação para o Firebase"
  lane :staging do
    clear_derived_data
    increment_build_number

    match(app_identifier: "#{Popcode::AppIdentifier::Staging}", type: "adhoc", force_for_new_devices: true)

    gym({
      export_method: "ad-hoc",
      export_options: @export_options_adhoc,
      scheme: Popcode::Scheme::Staging,
      silent: true,
      suppress_xcode_output: true,
      configuration: Popcode::Configuration::Staging
    })

    sh(
      step_name: "Copiando binário para o ofuscador",
      command: "scp '../Mulvi Pay.ipa' <USER YOUR SERVER>@<YOUR SERVER ADRESS>:<PATH TO COPY IPA>/staging/app.protected.ipa" # Você precisa alterar esse comando
    )
    sh(
      step_name: "Copiando arquivo de configuração do dexprotector para o ofuscador",
      command: "scp ../dexprotector-config-ipa.xml <USER YOUR SERVER>@<YOUR SERVER ADRESS>:<PATH TO COPY XML>/staging" # Você precisa alterar esse comando
    )
    sh(
      step_name: "Executando o script de ofuscamento",
      command: "ssh <USER YOUR SERVER>@<YOUR SERVER ADRESS> 'bash -s' < obfuscateBinary.sh staging ipa" # Você precisa alterar esse comando
    )
    sh(
      step_name: "Copiando binário ofuscado para a máquina local",
      command: "scp <USER YOUR SERVER>@<YOUR SERVER ADRESS>:<PATH TO COPY PROTECTED IPA>/staging/app.protected.ipa ../" # Você precisa alterar esse comando
    )

    get_provisioning_profile(
      adhoc: true,
      force: true,
      app_identifier: Popcode::AppIdentifier::Staging,
      filename: "#{Popcode::AppIdentifier::Staging}.mobileprovision"
    )

    resign(
      ipa: "app.protected.ipa",
      signing_identity: "<YOUR SIGNING CERTIFICATE> EX: iPhone Distribution: Luka Mirosevic (0123456789)", # Você precisa alterar esse campo
      provisioning_profile: "#{Popcode::AppIdentifier::Staging}.mobileprovision"
    )

    firebase_app_distribution(
      app: Popcode::Firebase::AppIdStaging,
      release_notes: @changelog,
      groups: "<groups>", # Você precisa alterar esse campo
      ipa_path: "app.protected.ipa"
    )
  end

  desc "Envia uma build de Produção para o Firebase"
  lane :release do
    clear_derived_data
    increment_build_number

    match(app_identifier: "#{Popcode::AppIdentifier::Production}", type: "adhoc", force_for_new_devices: true)

    gym({
      export_method: "ad-hoc",
      export_options: @export_options_adhoc,
      scheme: Popcode::Scheme::Production,
      silent: true,
      suppress_xcode_output: true,
      configuration: Popcode::Configuration::Production
    })

    sh(
      step_name: "Copiando binário para o ofuscador",
      command: "scp '../Mulvi Pay.ipa' <USER YOUR SERVER>@<YOUR SERVER ADRESS>:<PATH TO COPY IPA>/release/app.ipa" # Você precisa alterar esse comando
    )
    sh(
      step_name: "Copiando arquivo de configuração do dexprotector para o ofuscador",
      command: "scp ../dexprotector-config-ipa.xml <USER YOUR SERVER>@<YOUR SERVER ADRESS>:<PATH TO COPY XML>/release" # Você precisa alterar esse comando
    )
    sh(
      step_name: "Executando o script de ofuscamento",
      command: "ssh <USER YOUR SERVER>@<YOUR SERVER ADRESS> 'bash -s' < obfuscateBinary.sh release ipa" # Você precisa alterar esse comando
    )
    sh(
      step_name: "Copiando binário ofuscado para a máquina local",
      command: "scp <USER YOUR SERVER>@<YOUR SERVER ADRESS>:<PATH TO COPY PROTECTED IPA>/release/app.protected.ipa ../" # Você precisa alterar esse comando
    )

    get_provisioning_profile(
      adhoc: true,
      force: true,
      app_identifier: Popcode::AppIdentifier::Production,
      filename: "#{Popcode::AppIdentifier::Production}.mobileprovision"
    )

    resign(
      ipa: "app.protected.ipa",
      signing_identity: "<YOUR SIGNING CERTIFICATE> EX: iPhone Distribution: Luka Mirosevic (0123456789)", # Você precisa alterar esse campo
      provisioning_profile: "#{Popcode::AppIdentifier::Production}.mobileprovision"
    )

    firebase_app_distribution(
      app:  Popcode::Firebase::AppIdProduction,
      release_notes: @changelog,
      groups: "<groups>", # Você precisa alterar esse campo
      ipa_path: "app.protected.ipa"
    )
  end

  desc "Envia uma nova versão para App Store"
  lane :store do
    clear_derived_data
    increment_build_number()

    match(app_identifier: "#{Popcode::AppIdentifier::Production}", type: "appstore", force_for_new_devices: true)

    gym({
      scheme: Popcode::Scheme::Production,
      export_method: "app-store",
      export_options: @export_options_appstore,
      silent: true,
      suppress_xcode_output: true,
    })

    sh(
      step_name: "Copiando binário para o ofuscador",
      command: "scp '../Mulvi Pay.ipa' <USER YOUR SERVER>@<YOUR SERVER ADRESS>:<PATH TO COPY IPA>/store/app.ipa" # Você precisa alterar esse comando
    )
    sh(
      step_name: "Copiando arquivo de configuração do dexprotector para o ofuscador",
      command: "scp ../dexprotector-config-ipa.xml <USER YOUR SERVER>@<YOUR SERVER ADRESS>:<PATH TO COPY XML>/store" # Você precisa alterar esse comando
    )
    sh(
      step_name: "Executando o script de ofuscamento",
      command: "ssh <USER YOUR SERVER>@<YOUR SERVER ADRESS> 'bash -s' < obfuscateBinary.sh store ipa" # Você precisa alterar esse comando
    )
    sh(
      step_name: "Copiando binário ofuscado para a máquina local",
      command: "scp <USER YOUR SERVER>@<YOUR SERVER ADRESS>:<PATH TO COPY PROTECTED IPA>/store/app.protected.ipa ../" # Você precisa alterar esse comando
    )
    sh(
      step_name: "Copiando o log de ofuscamento para a máquina local",
      command: "scp <USER YOUR SERVER>@<YOUR SERVER ADRESS>:<PATH TO COPY LOG DEXPROTECTOR>/store/app.protected.ipa.txt ../" # Você precisa alterar esse comando
    )

    get_provisioning_profile(
      adhoc: true,
      force: true,
      app_identifier: Popcode::AppIdentifier::Production,
      filename: "#{Popcode::AppIdentifier::Production}.mobileprovision"
    )

    resign(
      ipa: "app.protected.ipa",
      signing_identity: "<YOUR SIGNING CERTIFICATE> EX: iPhone Distribution: Luka Mirosevic (0123456789)", # Você precisa alterar esse campo
      provisioning_profile: "#{Popcode::AppIdentifier::Production}.mobileprovision"
    )

    pilot(
      app_identifier: Popcode::AppIdentifier::Production,
      verbose: false,
      distribute_external: false,
      ipa: "app.protected.ipa"
    )
  end
end
